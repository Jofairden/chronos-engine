package chronos.engine.infrastructure.modules

import chronos.engine.domain.api.mobula.MobulaService
import io.ktor.client.HttpClientConfig
import io.ktor.client.engine.okhttp.OkHttpConfig
import io.ktor.client.plugins.defaultRequest
import io.ktor.client.request.headers
import io.ktor.http.HttpHeaders
import io.ktor.http.URLProtocol
import org.koin.core.module.dsl.createdAtStart
import org.koin.core.module.dsl.singleOf
import org.koin.core.qualifier.named
import org.koin.dsl.module
import org.openapi.Mobula.api.MobulaApi

private val mobulaHttpModule =
  module {
    scope<MobulaService> {
      scoped {
        // Http Client that can be freely used in the API object
        generateHttpClient {
          defaultRequest {
            val baseUrl by inject<String>(named("mobula.api.baseurl"))
            val key by inject<String>(named("mobula.api.key"))
            url {
              host = baseUrl
              protocol = URLProtocol.HTTPS
            }
            headers {
              append(HttpHeaders.Accept, "application/json")
              append(HttpHeaders.UserAgent, "Chronos Engine Mobula API")
              append(HttpHeaders.Authorization, key)
            }
          }
        }
      }
    }
  }

val mobulaModule =
  module {
    single<String>(named("mobula.api.baseurl"), createdAtStart = true) {
      getProperty("mobula.api.baseurl")
    }
    single<String>(named("mobula.api.key"), createdAtStart = true) {
      getProperty("mobula.api.key")
    }
    singleOf(::MobulaService) { createdAtStart() }
    // Market Api generated by OpenApiGenerator
    // We set the api key in the apply block
    single<MobulaApi>(createdAtStart = true) {
      val key by inject<String>(named("mobula.api.key"))
      MobulaApi(
        httpClientConfig = {
          with(it as HttpClientConfig<OkHttpConfig>) {
            buildDefaultHttpClient()
          }
        },
        jsonBlock = { buildGson() },
      ).apply { setApiKey(key) }
    }
    includes(mobulaHttpModule)
  }
